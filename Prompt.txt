# 実装依頼：Phase1 レーティング（Elo）+ キャラ統計（Pick/Win）

これまで確定した詳細設計に基づき、Phase1の実装をお願いします。

────────────────────────────
■ 目的
────────────────────────────

- rankedマッチのみ：
  - BO3最終結果で1回だけElo更新
  - charaStats（Pick/Win）加算
- private（合言葉）マッチは
  - レート更新しない
  - 統計にも含めない
- roomsはTransaction成功後にP1のみ削除

Phase1ではCloud Functionsは使用しません。
クライアント + Firestore Transactionで完結させます。

────────────────────────────
■ 実装要件（確定仕様）
────────────────────────────

【レート仕様】
- 初期rating: 1500
- 下限: 100
- K値:
    matchCount < 10   → 48
    < 50              → 32
    それ以上         → 16
- BO3最終結果で1回のみ更新
- leave/timeoutは通常敗北の減少量 ×1.5（正の減少量で計算）

【ランク帯】
Bronze        ：100–1399
Silver        ：1400–1599
Gold          ：1600–1799
Legend        ：1800–1999
Bakata Legend ：2000+

【キャラ統計】
- 保存先: charaStats/{charaId}
- rankedのみ対象
- Pick: 両キャラ +1
- Win: 勝者キャラ +1
- 同一キャラ対戦は 1doc にまとめて pick+2 / win+1

【実行条件】
rooms:
- bo3Final == true
- rated == false
- matchType == "ranked"

上記を満たすときのみ Transaction 実行。

【処理順序（重要）】
1. rooms読み込み
2. 条件チェック（冪等性）
3. users読み込み（勝者/敗者）
4. Elo計算
5. charaStats更新
6. users更新
7. rooms.rated = true
8. Transaction成功後に deleteDoc(rooms)（P1のみ）

────────────────────────────
■ Security Rules（Phase1最小防御）
────────────────────────────

- users：
  auth必須 + フィールド制限 + 型制限 + rating>=100
- rooms：
  ratedはfalse→trueのみ許可
  deleteはp1Uidのみ許可
- charaStats：
  auth必須 + フィールド制限 + 型制限 + 非負

────────────────────────────
■ 注意点
────────────────────────────

- 同一キャラ対戦は必ず1doc更新にまとめること
- leave倍率は負の値に1.5をかけない（減少量を正で扱う）
- Math.max(100, ...) は倍率適用後に行う
- Transaction内で必ず get → write の順序を守る
- private(matchType!="ranked")は即return

────────────────────────────
■ 実装完了後に確認したい点
────────────────────────────

- ranked1試合で users / charaStats が正しく更新される
- privateでは更新されない
- 同一キャラ対戦で pick+2 / win+1 になる
- roomsがTransaction成功後に削除される
- 二重実行しても更新されない（ratedフラグで防止）

以上の仕様で実装してください。
必要であれば既存コード構造に合わせて関数分割・最適化してOKです。
